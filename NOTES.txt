Download github repo
====================
https://github.com/rcc-uchicago/genetic-data-analysis-1

Set up your cluster computing environment
=========================================
1. Connect to midway2 (see https://rcc.uchicago.edu/docs/connecting).
2. Request 4 CPUs and 10 GB memory on a midway2 compute node:
     sinteractive --partition=broadwl --time=3:00:00 --mem=10G \
       --cpus-per-task=4
3. Make sure that you can display graphics, e.g.
     module load R/3.4.3
     R
     plot(cars$dist,cars$speed)
   You should see a scatterplot. If not, then you need to use a
   different method to connect to midway2.

Download 1000 Genomes data
==========================
* Download URL for 1000 Genomes data (European Bioinformatics Institute):
  ftp://ftp.1000genomes.ebi.ac.uk/vol1/ftp/release/20130502/supporting/hd_genotype_chip
* File to download from FTP site: 
  ALL.chip.omni_broad_sanger_combined.20140818.snps.genotypes.vcf.gz
* Downloading should take a few minutes.
* Commands to download 1000 Genomes data:
    cd data
    wget http://bit.ly/2C617oO -O 1kg.vcf.gz

Download PLINK
==============
* Download URL for PLINK: http://www.cog-genomics.org/plink2
* Commands to set up PLINK 1.9b5.2:
    cd bin
    wget http://bit.ly/2nUxOQX -O plink.zip // Download 64-bit Linux binary.
    unzip plink.zip                         // Uncompress ZIP file.

Explore VCF file
================
* http://www.cog-genomics.org/plink2/formats#vcf
* Commands to explore the 1000 Genomes data:
    ls -lh 1kg.vcf.gz         // 22 GB uncompressed.
    zcat 1kg.vcf.gz | less -S // gzcat on Mac.

Convert VCF to PLINK
====================
* We convert the from VCF to PLINK (.bed/.bim/.bam) format, retaining
  only SNPs on autosomal chromosomes 1-22. Also, remove any SNPs in
  which the proportion of missing genotypes is greater than negligible
  (>1%). These steps are taken to simplify the analyses of these data.
* Command to convert from VCF to PLINK text format:
    ../bin/plink --vcf 1kg.vcf.gz --recode --chr 1-22 \
       --allow-extra-chr --geno 0.01 --out 1kg

Explore PLINK file
==================
* .map format: (1) chromosome, (2) marker id, (3) genetic distance on
  chromosome (cM), base-pair position on chromosome.
* .ped format: (1) family id, (2) individual id, (3) father id, (4)
  mother id, (5) gender, (6) phenotype, (7-) genotypes
* Commands to explore the genetic data:
    ls -lh 1kg.map 1kg.ped
    head 1kg.map
    tail 1kg.map
    wc -l 1kg.map
    less -S 1kg.map
    wc -l -w 1kg.ped

Prepare 1000 Genomes data
=========================
* Convert to PLINK binary format. This should create 3 new files:
  1kg.bed, 1kg.bim, 1kg.fam:
    ../bin/plink --file 1kg --make-bed --out 1kg
* Remove 29 of 31 related samples:
    cut -f 1 20140625_related_individuals.txt > temp.txt
    paste temp.txt temp.txt > samples.txt
    ../bin/plink --bfile 1kg --make-bed --remove samples.txt \
      --out 1kg_unrelated

Merge with Affymetrix Human Origins data
========================================
* Commands to merge the two data sets:
    ../bin/plink --bfile 1kg_unrelated --extract 1kg_origins_markers.txt \
      --make-bed --out 1kg_unrelated_reduced
    ../bin/plink --bfile origins --extract 1kg_origins_markers.txt \
      --remove dupids.txt --make-bed --out origins_reduced
    ../bin/plink --bfile 1kg_unrelated_reduced --bmerge origins_reduced \
      --out 1kg_origins_combined
* "Prune" SNPs in LD (typically you will want to be more aggressive):
    ../bin/plink --bfile 1kg_origins_combined --indep-pairwise 1000 500 0.8
    ../bin/plink --bfile 1kg_origins_combined --make-bed \
      --extract plink.prune.in --out 1kg_origins_pruned

Run PCA on combined data set
============================
* We are going to use the rsvd package in R to compute PCs.
* Convert genotypes to a numeric format that will be more convenient
  for analysis in R:
    ../bin/plink --bfile 1kg_origins_pruned --recode A \
      --out 1kg_origins_recoded
* Move to the repository root, and start up R:
    cd ..
    module load R/3.4.3
    export OPENBLAS_NUM_THREADS=4 (optional)
    R --no-save
* Load the genotype data into R: 
    library(data.table)
    source("code/geno.utils.R")
    getwd()
    geno <- read.geno.raw("data/1kg_origins_recoded.raw")
    class(geno)
    dim(geno)
    geno[1:5,1:5]
* We need to fill in the missing genotypes:
    100*mean(is.na(geno))
    p <- ncol(geno)
    x <- colMeans(geno,na.rm = TRUE)
    for (j in 1:p) {
      i         <- which(is.na(geno[,j]))
      geno[i,j] <- x[j]
    }
    sum(is.na(geno))
* Compute the first 10 PCs (components explaining the most variation
  in the genotypes):
    library(rsvd)
    out.pca <- rpca(geno,k = 10,center = TRUE,scale = FALSE,retx = TRUE)
    summary(out.pca)
    head(out.pca$x)
    pcs <- out.pca$x
    colnames(pcs) <- paste0("PC",1:10)
* Let's save the results of our analysis.
    save(file = "output/1kg_origins_pca.RData",
         list = c("out.pca","pcs"))

Visualize & interpret PCA results
=================================
* Load the ggplot2 package and load the PC results just in case you
  don't already have them loaded:
    library(ggplot2)
    library(cowplot)
    source("code/geno.utils.R")
    load("output/1kg_origins_pca.RData")
* Let's plot all samples projected onto the first 2 PCs:
    p <- basic.pc.plot(pcs,x = "PC1",y = "PC2")
    print(p)
* There is definitely structure, but it is difficult to
  interpret---let's visualize the samples with their population
  labels. To do so, let's load the population labels assigned to the
  1000 Genomes samples:
    labels.1kg <- read.table("data/omni_samples.20141118.panel",
                             sep = " ",header = TRUE,as.is = "id")
    pcs <- add.poplabels(pcs,labels.1kg)
    head(pcs)
    p2 <- labeled.pc.plot(pcs,x = "PC1",y = "PC2",label = "label")
* Take time to discuss interesting insights from this plot. Make use
  of the 1kg.pop to interpret labels.
* One missing element here is the labels for the 5 samples from the
  Human Origins data set. It would be good to show the sample ids for
  these 5 samples so that we can interpret their projection onto the
  top 2 PCs. I've created a third (slightly more complicated) plotting
  function to accomplish this.
